summary: TODO

environment:
  TMPFSMOUNT: /var/lib/snapd

prepare: |
  systemctl stop snapd.{socket,service}

  # create a copy of /var/lib/snapd on a tmpfs that is just slightly
  # larger than currently occupied disk space; mount it over original
  # /var/lib/snapd for this test.
  SIZE=$(expr $(du -s --block-size=1048576 /var/lib/snapd | awk '{print $1}') + 2)
  mv "$TMPFSMOUNT" "$TMPFSMOUNT.real"
  mkdir "$TMPFSMOUNT"
  mount -t tmpfs tmpfs -o size="${SIZE}M" "$TMPFSMOUNT"
  cp -ar "$TMPFSMOUNT.real" "$TMPFSMOUNT"

  systemctl start snapd.{socket,service}

restore: |
  systemctl stop snapd.{socket,service}
  umount -l "$TMPFSMOUNT"
  rmdir "$TMPFSMOUNT"
  mv "$TMPFSMOUNT.real" "$TMPFSMOUNT"
  systemctl start snapd.{socket,service}

execute: |
  resize() {
    mount -o remount,size="$1" "$TMPFSMOUNT"
  }

  echo "Snap download fails with little disk space"
  snap install hello-world 2>&1 | MATCH "Ensure prerequisites for \"hello-world\" are available \(cannot install snap base \"core\": not enough free space in /var/lib/snapd, requires 98MB\)"

  echo "And succeeds with enough space"
  resize 600M
  snap install hello-world
